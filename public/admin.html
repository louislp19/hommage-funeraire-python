<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin â€” Hommages</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .event-card {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .event-portrait {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(201, 168, 76, 0.4);
            flex-shrink: 0;
        }
        .event-portrait-placeholder {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(201, 168, 76, 0.2);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .event-info {
            flex: 1;
            min-width: 0;
        }
        .event-name {
            font-size: 1.15rem;
            color: #c9a84c;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        .event-meta {
            font-size: 0.8rem;
            color: #666;
            font-family: Arial, sans-serif;
            margin-bottom: 12px;
        }
        .duration-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .duration-row label {
            font-size: 0.8rem;
            color: #666;
            margin: 0;
            text-transform: none;
            letter-spacing: 0;
            white-space: nowrap;
        }
        .duration-row select {
            width: auto;
            padding: 6px 10px;
            font-size: 13px;
            margin: 0;
        }
        .event-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .event-links-bottom {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }
        .btn-sm {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 3px;
            text-decoration: none;
            font-family: Arial, sans-serif;
            letter-spacing: 0.5px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            display: inline-block;
        }
        .btn-sm-gold   { background: #c9a84c; color: #111318; }
        .btn-sm-gold:hover { background: #dbbf5e; }
        .btn-sm-outline {
            background: transparent;
            color: #c9a84c;
            border: 1px solid rgba(201, 168, 76, 0.45);
        }
        .btn-sm-outline:hover { border-color: #c9a84c; }
        .btn-sm-ghost {
            background: rgba(201, 168, 76, 0.08);
            color: #888;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .btn-sm-ghost:hover { color: #c9a84c; }
        .btn-backup {
            display: block;
            width: 100%;
            text-align: center;
            background: transparent;
            color: #7dbb8a;
            border: 1px solid rgba(125, 187, 138, 0.4);
            padding: 8px;
            border-radius: 3px;
            font-size: 13px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            margin-top: 10px;
            letter-spacing: 0.5px;
            transition: border-color 0.2s, background 0.2s;
        }
        .btn-backup:hover {
            border-color: #7dbb8a;
            background: rgba(125, 187, 138, 0.07);
        }
        /* Delete button */
        .card-wrap {
            position: relative;
        }
        .btn-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: #554444;
            font-size: 18px;
            cursor: pointer;
            line-height: 1;
            padding: 4px 6px;
            border-radius: 3px;
            transition: color 0.2s, background 0.2s;
        }
        .btn-delete:hover {
            color: #d07070;
            background: rgba(208, 112, 112, 0.1);
        }
        #loading {
            text-align: center;
            color: #666;
            padding: 40px 0;
            font-family: Arial, sans-serif;
        }
        .empty-state {
            text-align: center;
            color: #555;
            padding: 40px 0;
            font-family: Arial, sans-serif;
        }
        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .back-link {
            font-size: 0.85rem;
            color: #666;
            text-decoration: none;
            font-family: Arial, sans-serif;
        }
        .back-link:hover { color: #c9a84c; }
    </style>
</head>
<body>
<div class="container">
    <div class="admin-header">
        <h1 style="margin-bottom:0">Hommages</h1>
        <a href="/" class="back-link">+ CrÃ©er un hommage</a>
    </div>
    <p class="subtitle">Tous les mÃ©moriaux enregistrÃ©s</p>

    <div id="loading">Chargement...</div>
    <div id="list"></div>
</div>

<div id="copy-confirm" class="copy-confirm" style="display:none">Lien copiÃ© !</div>

<script>
function slugToName(slug) {
    return slug.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}

function formatDate(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleDateString('fr-CA', { year: 'numeric', month: 'long', day: 'numeric' });
}

function copyText(text) {
    navigator.clipboard.writeText(text).then(() => {
        const el = document.getElementById('copy-confirm');
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 2000);
    });
}

async function deleteEvent(slug, cardWrap) {
    const name = slugToName(slug);
    if (!confirm(`Supprimer le mÃ©morial "${name}" et toutes ses photos ?\n\nCette action est irrÃ©versible.`)) return;

    const btn = cardWrap.querySelector('.btn-delete');
    btn.textContent = '...';
    btn.disabled = true;

    try {
        const res = await fetch('/api/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event: slug })
        });
        const data = await res.json();
        if (data.success) {
            cardWrap.style.transition = 'opacity 0.3s';
            cardWrap.style.opacity = '0';
            setTimeout(() => cardWrap.remove(), 300);
            const list = document.getElementById('list');
            if (!list.children.length) {
                list.innerHTML = '<div class="empty-state">Aucun mÃ©morial trouvÃ©.</div>';
            }
        } else {
            alert('Erreur : ' + (data.error || 'Suppression Ã©chouÃ©e'));
            btn.textContent = 'ðŸ—‘';
            btn.disabled = false;
        }
    } catch (e) {
        alert('Erreur rÃ©seau');
        btn.textContent = 'ðŸ—‘';
        btn.disabled = false;
    }
}

function buildCard(ev) {
    const slug = ev.slug;
    const name = slugToName(slug);
    const base = window.location.origin;
    const durId = `dur-${slug}`;

    const wrap = document.createElement('div');
    wrap.className = 'card-wrap';

    let portraitHtml = ev.portrait
        ? `<img class="event-portrait" src="${ev.portrait}" alt="${name}">`
        : `<div class="event-portrait-placeholder">âœ¦</div>`;

    wrap.innerHTML = `
        <div class="card">
            <button class="btn-delete" title="Supprimer ce mÃ©morial">ðŸ—‘</button>
            <div class="event-card">
                ${portraitHtml}
                <div class="event-info">
                    <div class="event-name">${name}</div>
                    <div class="event-meta">${ev.count} photo${ev.count !== 1 ? 's' : ''} Â· ${formatDate(ev.latest)}</div>
                    <div class="duration-row">
                        <label for="${durId}">DurÃ©e des slides :</label>
                        <select id="${durId}">
                            <option value="3">3 s</option>
                            <option value="5" selected>5 s</option>
                            <option value="7">7 s</option>
                            <option value="10">10 s</option>
                            <option value="15">15 s</option>
                            <option value="20">20 s</option>
                            <option value="30">30 s</option>
                        </select>
                    </div>
                    <div class="event-links">
                        <a class="btn-sm btn-sm-gold" href="${base}/upload.html?event=${slug}&name=${encodeURIComponent(name)}" target="_blank">â†‘ Upload</a>
                        <a class="btn-sm btn-sm-outline slideshow-link" href="#" target="_blank">â–¶ Slideshow</a>
                        <button class="btn-sm btn-sm-ghost qr-btn">ðŸ“± QR Code</button>
                        <button class="btn-sm btn-sm-ghost copy-upload-btn">Copier upload</button>
                        <button class="btn-sm btn-sm-ghost copy-slideshow-btn">Copier slideshow</button>
                    </div>
                    <a class="btn-backup" href="${base}/manage.html?event=${slug}&name=${encodeURIComponent(name)}" target="_blank">âš™ Espace famille (gestion + suppression de photos)</a>
                    <a class="btn-backup backup-link" href="${base}/backup.html?event=${slug}&name=${encodeURIComponent(name)}" target="_blank" style="color:#7dbb8a;border-color:rgba(125,187,138,0.4);">â¬‡ TÃ©lÃ©charger toutes les photos (backup)</a>
                </div>
            </div>
        </div>`;

    const durSelect = wrap.querySelector(`#${durId}`);
    const slideshowAnchor = wrap.querySelector('.slideshow-link');

    function updateSlideshowHref() {
        const dur = durSelect.value;
        slideshowAnchor.href = `${base}/slideshow.html?event=${slug}&name=${encodeURIComponent(name)}&duration=${dur}`;
    }
    updateSlideshowHref();
    durSelect.addEventListener('change', updateSlideshowHref);

    wrap.querySelector('.copy-upload-btn').addEventListener('click', () => {
        const dur = durSelect.value;
        copyText(`${base}/upload.html?event=${slug}&name=${encodeURIComponent(name)}&duration=${dur}`);
    });
    wrap.querySelector('.copy-slideshow-btn').addEventListener('click', () => {
        const dur = durSelect.value;
        copyText(`${base}/slideshow.html?event=${slug}&name=${encodeURIComponent(name)}&duration=${dur}`);
    });
    wrap.querySelector('.btn-delete').addEventListener('click', () => deleteEvent(slug, wrap));
    wrap.querySelector('.qr-btn').addEventListener('click', () => {
        const dur = durSelect.value;
        const uploadUrl = `${base}/upload.html?event=${slug}&name=${encodeURIComponent(name)}&duration=${dur}`;
        showQR(uploadUrl, name);
    });

    return wrap;
}

async function load() {
    try {
        const res = await fetch('/api/events');
        const data = await res.json();
        document.getElementById('loading').style.display = 'none';
        const list = document.getElementById('list');

        if (!Array.isArray(data) || data.length === 0) {
            list.innerHTML = '<div class="empty-state">Aucun mÃ©morial trouvÃ©.</div>';
            return;
        }

        data.forEach(ev => list.appendChild(buildCard(ev)));
    } catch (e) {
        document.getElementById('loading').textContent = 'Erreur de chargement.';
    }
}

load();

// QR Code modal
function showQR(url, label) {
    const modal = document.getElementById('qr-modal');
    const canvas = document.getElementById('qr-canvas');
    canvas.innerHTML = '';
    document.getElementById('qr-label').textContent = `Page d'envoi de photos â€” ${label}`;
    document.getElementById('qr-url').textContent = url;
    modal._url = url;
    modal._label = label;
    modal.style.display = 'flex';
    new QRCode(canvas, {
        text: url,
        width: 260,
        height: 260,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
    });
}

function closeQR() {
    document.getElementById('qr-modal').style.display = 'none';
}

function printQR() {
    const modal = document.getElementById('qr-modal');
    const canvas = document.getElementById('qr-canvas');
    const img = canvas.querySelector('img') || canvas.querySelector('canvas');
    const src = img.tagName === 'CANVAS' ? img.toDataURL() : img.src;
    const label = modal._label || '';
    const url = modal._url || '';
    const win = window.open('', '_blank');
    win.document.write(`<!DOCTYPE html><html><head><title>QR Code â€” ${label}</title>
        <style>body{margin:0;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:Arial,sans-serif;}
        img{width:320px;height:320px;}h2{margin-bottom:12px;font-size:20px;letter-spacing:1px;}
        p{margin-top:14px;font-size:12px;color:#555;text-align:center;word-break:break-all;max-width:340px;}</style></head>
        <body><h2>${label}</h2><img src="${src}"><p>${url}</p></body></html>`);
    win.document.close();
    win.focus();
    win.print();
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- QR Modal -->
<div id="qr-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:200;align-items:center;justify-content:center;flex-direction:column;" onclick="closeQR()">
    <div style="background:#fff;padding:28px;border-radius:8px;text-align:center;max-width:90vw;" onclick="event.stopPropagation()">
        <p style="font-family:Arial,sans-serif;font-size:13px;color:#444;margin-bottom:14px;font-weight:bold;" id="qr-label"></p>
        <div id="qr-canvas"></div>
        <p style="font-family:monospace;font-size:11px;color:#888;margin-top:10px;word-break:break-all;max-width:280px;" id="qr-url"></p>
        <div style="margin-top:14px;display:flex;gap:10px;justify-content:center;">
            <button onclick="printQR()" style="background:#111318;color:#c9a84c;border:none;padding:8px 18px;border-radius:4px;font-size:13px;cursor:pointer;font-weight:bold;">Imprimer</button>
            <button onclick="closeQR()" style="background:#eee;color:#333;border:none;padding:8px 18px;border-radius:4px;font-size:13px;cursor:pointer;">Fermer</button>
        </div>
    </div>
</div>
</body>
</html>
