<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mémorial</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #000;
            height: 100vh;
            overflow: hidden;
            font-family: Georgia, serif;
            cursor: pointer;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        .slide {
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
        }

        .slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .slide.active {
            opacity: 1;
        }

        #name-display {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.9);
            font-size: 26px;
            letter-spacing: 3px;
            text-shadow: 1px 1px 6px rgba(0,0,0,0.9);
            z-index: 10;
            white-space: nowrap;
        }

        #counter {
            position: fixed;
            top: 20px;
            right: 20px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 13px;
            font-family: Arial, sans-serif;
            z-index: 10;
        }

        #message {
            color: rgba(255,255,255,0.7);
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            font-family: Georgia, serif;
        }
    </style>
</head>
<body>

<div id="container">
    <div id="message">Chargement des photos...</div>
</div>
<div id="name-display"></div>
<div id="counter"></div>

<script>
const params = new URLSearchParams(window.location.search);
const event = params.get('event') || 'default';
const name = params.get('name') || 'Mémorial';

document.getElementById('name-display').textContent = name;
document.title = `Mémorial — ${name}`;

const container = document.getElementById('container');
const counter = document.getElementById('counter');

let knownUrls = new Set();
let slideElements = [];
let currentIndex = 0;
let slideTimer = null;

// Click or tap to toggle fullscreen
document.body.addEventListener('click', () => {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(() => {});
    } else {
        document.exitFullscreen().catch(() => {});
    }
});

function showSlide(index) {
    slideElements.forEach((el, i) => el.classList.toggle('active', i === index));
    counter.textContent = `${index + 1} / ${slideElements.length}`;
}

function nextSlide() {
    if (slideElements.length === 0) return;
    currentIndex = (currentIndex + 1) % slideElements.length;
    showSlide(currentIndex);
}

function addSlide(url) {
    const slide = document.createElement('div');
    slide.className = 'slide';
    const img = document.createElement('img');
    img.src = url;
    img.alt = name;
    slide.appendChild(img);
    container.appendChild(slide);
    slideElements.push(slide);
}

async function loadImages() {
    try {
        const res = await fetch(`/api/images?event=${encodeURIComponent(event)}&t=${Date.now()}`);
        if (!res.ok) return;
        const urls = await res.json();
        if (!Array.isArray(urls)) return;

        // Add only new images (don't restart slideshow)
        const newUrls = urls.filter(u => !knownUrls.has(u));
        newUrls.forEach(url => {
            knownUrls.add(url);
            addSlide(url);
        });

        // Remove loading message and start timer once we have images
        const msg = document.getElementById('message');
        if (msg) msg.remove();

        if (slideElements.length > 0 && !slideTimer) {
            showSlide(0);
            slideTimer = setInterval(nextSlide, 5000);
        }

        if (slideElements.length === 0) {
            if (!document.getElementById('message')) {
                const msg = document.createElement('div');
                msg.id = 'message';
                msg.textContent = 'Aucune photo disponible pour le moment. Les photos s\'afficheront automatiquement dès qu\'elles seront ajoutées.';
                container.appendChild(msg);
            }
        }

    } catch (e) {
        console.error('Erreur chargement:', e);
    }
}

// Initial load then refresh every 30 seconds to pick up new photos
loadImages();
setInterval(loadImages, 30000);
</script>
</body>
</html>
