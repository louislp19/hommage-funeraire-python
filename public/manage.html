<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gérer le mémorial</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        input[type="password"] {
            width: 100%;
            padding: 12px 14px;
            font-size: 16px;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(201, 168, 76, 0.3);
            border-radius: 4px;
            color: #ddd8cc;
            margin-bottom: 16px;
            transition: border-color 0.2s;
            letter-spacing: 4px;
        }
        input[type="password"]:focus {
            outline: none;
            border-color: #c9a84c;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 4px;
            overflow: hidden;
            background: #1a1a20;
        }
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .photo-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.72);
            color: #d07070;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.15s;
            font-weight: bold;
        }
        .photo-item:hover .photo-delete { opacity: 1; }
        @media (hover: none) {
            .photo-delete { opacity: 1; }
        }
        .photo-item.deleting {
            opacity: 0.3;
            pointer-events: none;
        }
        .pin-dots {
            text-align: center;
            font-size: 0.8rem;
            color: #555;
            font-family: Arial, sans-serif;
            margin-top: -10px;
            margin-bottom: 14px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 id="page-title">Mémorial</h1>
    <p class="subtitle" id="page-sub">Espace famille</p>

    <!-- PIN form -->
    <div class="card" id="pin-card">
        <h2>Accès sécurisé</h2>
        <label for="pin-input">Code PIN</label>
        <input type="password" id="pin-input" placeholder="• • • •" autocomplete="off" inputmode="numeric">
        <p class="pin-dots">Fourni par votre salon funéraire</p>
        <button id="pin-btn" onclick="verifyPin()">Accéder</button>
        <p id="pin-error" class="error" style="display:none">PIN incorrect. Veuillez réessayer.</p>
    </div>

    <!-- Management interface -->
    <div id="manage-area" style="display:none">

        <div class="card">
            <h2>Durée des slides</h2>
            <label for="duration-select">Durée d'affichage par photo</label>
            <select id="duration-select">
                <option value="3">3 secondes</option>
                <option value="5">5 secondes</option>
                <option value="7">7 secondes</option>
                <option value="10">10 secondes</option>
                <option value="15">15 secondes</option>
                <option value="20">20 secondes</option>
                <option value="30">30 secondes</option>
            </select>
            <button onclick="saveDuration()">Sauvegarder</button>
            <p id="duration-ok" class="success" style="display:none">✓ Durée mise à jour</p>
        </div>

        <div class="card">
            <h2>Photos (<span id="photo-count">0</span>)</h2>
            <p class="label-text" style="margin-bottom:16px;">Appuyez sur ✕ pour retirer une photo</p>
            <div id="photo-grid" class="photo-grid"></div>
            <p id="photos-loading" class="progress-text" style="text-align:center;padding:20px 0;">Chargement des photos...</p>
            <p id="no-photos" class="progress-text" style="display:none;text-align:center;padding:20px 0;">Aucune photo pour le moment.</p>
        </div>

    </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const event = params.get('event') || 'default';
const name = params.get('name') || 'Mémorial';
let currentPin = '';

document.getElementById('page-title').textContent = name;
document.getElementById('page-sub').textContent = `Espace famille — ${name}`;
document.title = `Gérer — ${name}`;

document.getElementById('pin-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') verifyPin();
});

async function verifyPin() {
    const pin = document.getElementById('pin-input').value.trim();
    if (!pin) return;
    const btn = document.getElementById('pin-btn');
    btn.disabled = true;
    btn.textContent = '...';
    document.getElementById('pin-error').style.display = 'none';

    try {
        const res = await fetch(`/api/config?event=${encodeURIComponent(event)}&pin=${encodeURIComponent(pin)}`);
        const data = await res.json();
        if (data.success) {
            currentPin = pin;
            document.getElementById('pin-card').style.display = 'none';
            document.getElementById('manage-area').style.display = 'block';
            const sel = document.getElementById('duration-select');
            if (data.duration) sel.value = data.duration;
            loadPhotos();
        } else {
            document.getElementById('pin-error').style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Accéder';
        }
    } catch (e) {
        document.getElementById('pin-error').textContent = 'Erreur de connexion.';
        document.getElementById('pin-error').style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Accéder';
    }
}

async function saveDuration() {
    const duration = document.getElementById('duration-select').value;
    const okEl = document.getElementById('duration-ok');
    try {
        const res = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event, pin: currentPin, action: 'update_duration', duration })
        });
        const data = await res.json();
        if (data.success) {
            okEl.style.display = 'block';
            setTimeout(() => okEl.style.display = 'none', 3000);
        }
    } catch (e) {}
}

async function loadPhotos() {
    try {
        const res = await fetch(`/api/images?event=${encodeURIComponent(event)}&t=${Date.now()}`);
        const urls = await res.json();
        document.getElementById('photos-loading').style.display = 'none';

        if (!Array.isArray(urls) || urls.length === 0) {
            document.getElementById('no-photos').style.display = 'block';
            return;
        }

        document.getElementById('photo-count').textContent = urls.length;
        const grid = document.getElementById('photo-grid');
        urls.forEach(url => grid.appendChild(buildPhotoItem(url)));
    } catch (e) {
        document.getElementById('photos-loading').textContent = 'Erreur de chargement.';
    }
}

function buildPhotoItem(url) {
    const item = document.createElement('div');
    item.className = 'photo-item';

    const img = document.createElement('img');
    img.src = url;
    img.alt = '';

    const btn = document.createElement('button');
    btn.className = 'photo-delete';
    btn.title = 'Supprimer cette photo';
    btn.textContent = '✕';
    btn.addEventListener('click', () => deletePhoto(url, item));

    item.appendChild(img);
    item.appendChild(btn);
    return item;
}

async function deletePhoto(url, item) {
    if (!confirm('Supprimer cette photo ?')) return;
    item.classList.add('deleting');

    try {
        const res = await fetch('/api/delete_photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event, pin: currentPin, url })
        });
        const data = await res.json();
        if (data.success) {
            item.style.transition = 'opacity 0.3s';
            item.style.opacity = '0';
            setTimeout(() => {
                item.remove();
                const remaining = document.querySelectorAll('.photo-item').length;
                document.getElementById('photo-count').textContent = remaining;
                if (remaining === 0) {
                    document.getElementById('no-photos').style.display = 'block';
                }
            }, 300);
        } else {
            alert('Erreur : ' + (data.error || 'Suppression échouée'));
            item.classList.remove('deleting');
        }
    } catch (e) {
        alert('Erreur réseau');
        item.classList.remove('deleting');
    }
}
</script>
</body>
</html>
