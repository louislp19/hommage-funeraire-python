<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hommage Funéraire</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div class="container">
    <h1>Hommage Funéraire</h1>
    <p class="subtitle">Créez une page mémorial pour partager des photos en souvenir d'un être cher</p>

    <div class="card">
        <h2>Créer un hommage</h2>
        <label for="defunt-name">Nom du défunt</label>
        <input type="text" id="defunt-name" placeholder="ex: Jean Tremblay" autocomplete="off">

        <label for="portrait-input" style="margin-top:14px;">Photo du défunt (optionnel)</label>
        <div class="portrait-pick" id="portrait-pick" onclick="document.getElementById('portrait-input').click()">
            <img id="portrait-preview" src="" alt="" style="display:none">
            <span id="portrait-placeholder">Cliquez pour choisir une photo</span>
        </div>
        <input type="file" id="portrait-input" accept="image/*" style="display:none">

        <label for="duration-select" style="margin-top:14px;">Durée d'affichage par photo</label>
        <select id="duration-select">
            <option value="3">3 secondes</option>
            <option value="5" selected>5 secondes (défaut)</option>
            <option value="7">7 secondes</option>
            <option value="10">10 secondes</option>
            <option value="15">15 secondes</option>
            <option value="20">20 secondes</option>
            <option value="30">30 secondes</option>
        </select>

        <label for="pin-input" style="margin-top:14px;">Code PIN famille</label>
        <input type="text" id="pin-input" placeholder="ex: 1234" maxlength="8" autocomplete="off" inputmode="numeric">

        <button id="generate-btn" onclick="genererLiens()">Générer les liens</button>
        <p id="generate-status" class="progress-text" style="margin-top:10px;display:none"></p>
    </div>

    <div class="card" id="links-card" style="display:none">
        <h2>Liens générés</h2>

        <p class="label-text">Lien à partager avec les proches pour envoyer des photos :</p>
        <div class="link-box" id="upload-link-text"></div>
        <button class="btn-copy" onclick="copyLink('upload')">Copier ce lien</button>

        <hr class="divider">

        <p class="label-text">Lien pour le slideshow (à projeter pendant l'événement) :</p>
        <div class="link-box" id="slideshow-link-text"></div>
        <button class="btn-copy" onclick="copyLink('slideshow')">Copier ce lien</button>

        <hr class="divider">

        <p class="label-text">Lien backup à envoyer à la famille après l'événement :</p>
        <div class="link-box" id="backup-link-text"></div>
        <button class="btn-copy" onclick="copyLink('backup')">Copier ce lien</button>

        <hr class="divider">

        <p class="label-text">Lien de gestion famille (protégé par PIN) :</p>
        <div class="link-box" id="manage-link-text"></div>
        <button class="btn-copy" onclick="copyLink('manage')">Copier ce lien</button>

        <hr class="divider">

        <div class="action-links">
            <a id="open-upload" class="btn-gold" target="_blank">Ouvrir la page d'upload</a>
            <a id="open-slideshow" class="btn-outline" target="_blank">Ouvrir le slideshow</a>
        </div>
    </div>

    <div id="copy-confirm" class="copy-confirm" style="display:none">Lien copié !</div>
</div>

<script>
let uploadUrl = '';
let slideshowUrl = '';
let backupUrl = '';
let manageUrl = '';

async function genererLiens() {
    const name = document.getElementById('defunt-name').value.trim();
    if (!name) {
        document.getElementById('defunt-name').focus();
        return;
    }

    const pin = document.getElementById('pin-input').value.trim();
    if (!pin) {
        document.getElementById('pin-input').focus();
        return;
    }

    const event = name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '')
        .slice(0, 50);

    const btn = document.getElementById('generate-btn');
    const statusEl = document.getElementById('generate-status');
    btn.disabled = true;

    // Upload portrait if one was selected
    let portraitUrl = '';
    const portraitFile = document.getElementById('portrait-input').files[0];
    if (portraitFile) {
        statusEl.textContent = 'Envoi de la photo...';
        statusEl.style.display = 'block';
        try {
            const formData = new FormData();
            formData.append('event', event);
            formData.append('photo', portraitFile);
            const res = await fetch('/api/portrait', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) portraitUrl = data.url;
        } catch (e) {
            console.error('Portrait upload error:', e);
        }
        statusEl.style.display = 'none';
    }

    // Save config (PIN + duration) to Vercel Blob
    statusEl.textContent = 'Sauvegarde de la configuration...';
    statusEl.style.display = 'block';
    try {
        await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event, pin, action: 'save', duration: document.getElementById('duration-select').value })
        });
    } catch (e) {
        console.error('Config save error:', e);
    }
    statusEl.style.display = 'none';

    btn.disabled = false;

    const duration = document.getElementById('duration-select').value;
    const base = window.location.origin;
    const portraitParam = portraitUrl ? `&portrait=${encodeURIComponent(portraitUrl)}` : '';
    uploadUrl = `${base}/upload.html?event=${event}&name=${encodeURIComponent(name)}&duration=${duration}${portraitParam}`;
    slideshowUrl = `${base}/slideshow.html?event=${event}&name=${encodeURIComponent(name)}&duration=${duration}`;
    backupUrl = `${base}/backup.html?event=${event}&name=${encodeURIComponent(name)}`;
    manageUrl = `${base}/manage.html?event=${event}&name=${encodeURIComponent(name)}`;

    document.getElementById('upload-link-text').textContent = uploadUrl;
    document.getElementById('slideshow-link-text').textContent = slideshowUrl;
    document.getElementById('backup-link-text').textContent = backupUrl;
    document.getElementById('manage-link-text').textContent = manageUrl;
    document.getElementById('open-upload').href = uploadUrl;
    document.getElementById('open-slideshow').href = slideshowUrl;
    document.getElementById('links-card').style.display = 'block';
}

function copyLink(type) {
    const text = type === 'upload' ? uploadUrl : type === 'backup' ? backupUrl : type === 'manage' ? manageUrl : slideshowUrl;
    navigator.clipboard.writeText(text).then(() => {
        const confirm = document.getElementById('copy-confirm');
        confirm.style.display = 'block';
        setTimeout(() => confirm.style.display = 'none', 2000);
    });
}

// Portrait preview
document.getElementById('portrait-input').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const img = document.getElementById('portrait-preview');
        img.src = e.target.result;
        img.style.display = 'block';
        document.getElementById('portrait-placeholder').style.display = 'none';
    };
    reader.readAsDataURL(file);
});

// Allow pressing Enter in the input field
document.getElementById('defunt-name').addEventListener('keydown', e => {
    if (e.key === 'Enter') genererLiens();
});
</script>
</body>
</html>
