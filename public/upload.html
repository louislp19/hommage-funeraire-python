<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envoyer des photos</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div class="container">
    <div id="salon-branding" class="salon-branding" style="display:none">
        <img id="salon-logo" class="salon-logo" src="" alt="">
        <p id="salon-name-text" class="salon-name-text"></p>
    </div>

    <div id="portrait-section" style="display:none">
        <div class="portrait-frame">
            <img id="portrait-img" src="" alt="">
        </div>
    </div>
    <h1 id="page-title">Hommage FunÃ©raire</h1>
    <p class="subtitle" id="page-sub">Partagez vos photos en souvenir</p>

    <div class="card">
        <label class="file-drop" for="file-input">
            <span class="file-icon">ðŸ“·</span>
            <span class="file-text">Cliquez ici pour choisir vos photos</span>
            <span class="file-hint">ou glissez-dÃ©posez les photos ici</span>
        </label>
        <input type="file" id="file-input" multiple accept="image/*" style="display:none">

        <p id="file-count" class="file-count-text">Aucune photo sÃ©lectionnÃ©e</p>

        <button id="upload-btn" onclick="startUpload()">Envoyer les photos</button>

        <div id="progress-area" style="display:none">
            <div class="progress-bar-wrap">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <p id="progress-text" class="progress-text">PrÃ©paration...</p>
        </div>

        <div id="status"></div>
    </div>

    <div class="card" id="links-card" style="display:none">
        <a id="slideshow-link" class="btn-gold btn-block">â–¶ Voir le Slideshow</a>
    </div>

    <div class="card">
        <p class="label-text" style="text-align:center;margin-bottom:14px;">Partager cette page par QR code</p>
        <button class="btn-outline btn-block" onclick="showQR()">ðŸ“± Afficher le QR Code</button>
    </div>
</div>

<!-- QR Modal -->
<div id="qr-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:200;display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px;" onclick="closeQR()">
    <div style="background:#fff;padding:28px;border-radius:8px;text-align:center;" onclick="event.stopPropagation()">
        <p style="font-family:Arial,sans-serif;font-size:13px;color:#444;margin-bottom:14px;" id="qr-label"></p>
        <div id="qr-canvas"></div>
        <div style="margin-top:16px;display:flex;gap:10px;justify-content:center;">
            <button onclick="printQR()" style="background:#111318;color:#c9a84c;border:none;padding:8px 18px;border-radius:4px;font-size:13px;cursor:pointer;font-weight:bold;">Imprimer</button>
            <button onclick="closeQR()" style="background:#eee;color:#333;border:none;padding:8px 18px;border-radius:4px;font-size:13px;cursor:pointer;">Fermer</button>
        </div>
    </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const event = params.get('event') || 'default';
const name = params.get('name') || 'MÃ©morial';

document.getElementById('page-title').textContent = name;
document.getElementById('page-sub').textContent = `Partagez vos photos en souvenir de ${name}`;
document.title = `Envoyer des photos - ${name}`;

const portrait = params.get('portrait');
if (portrait) {
    document.getElementById('portrait-img').src = portrait;
    document.getElementById('portrait-img').alt = name;
    document.getElementById('portrait-section').style.display = 'block';
}

const duration = params.get('duration') || '5';
const slideshowUrl = `/slideshow.html?event=${encodeURIComponent(event)}&name=${encodeURIComponent(name)}&duration=${duration}`;
document.getElementById('slideshow-link').href = slideshowUrl;

// File input handling
const fileInput = document.getElementById('file-input');
const fileDrop = document.querySelector('.file-drop');

fileDrop.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', updateFileCount);

// Drag and drop
fileDrop.addEventListener('dragover', e => { e.preventDefault(); fileDrop.classList.add('drag-over'); });
fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('drag-over'));
fileDrop.addEventListener('drop', e => {
    e.preventDefault();
    fileDrop.classList.remove('drag-over');
    fileInput.files = e.dataTransfer.files;
    updateFileCount();
});

function updateFileCount() {
    const count = fileInput.files.length;
    document.getElementById('file-count').textContent =
        count === 0 ? 'Aucune photo sÃ©lectionnÃ©e' :
        count === 1 ? '1 photo sÃ©lectionnÃ©e' :
        `${count} photos sÃ©lectionnÃ©es`;
}

// Compress an image using Canvas (keeps images under ~600KB to respect Vercel's 4.5MB limit)
function compressImage(file) {
    return new Promise(resolve => {
        // Skip non-compressible types (HEIC, GIF, etc.)
        if (!['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) {
            resolve(file);
            return;
        }
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
            URL.revokeObjectURL(url);
            const MAX = 1920;
            let { width, height } = img;
            if (width > MAX || height > MAX) {
                if (width >= height) { height = Math.round(height * MAX / width); width = MAX; }
                else { width = Math.round(width * MAX / height); height = MAX; }
            }
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            canvas.toBlob(
                blob => resolve(new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' })),
                'image/jpeg', 0.85
            );
        };
        img.onerror = () => { URL.revokeObjectURL(url); resolve(file); };
        img.src = url;
    });
}

async function startUpload() {
    const files = Array.from(fileInput.files);
    const status = document.getElementById('status');

    if (files.length === 0) {
        status.innerHTML = '<p class="error">Veuillez choisir au moins une photo.</p>';
        return;
    }

    document.getElementById('upload-btn').disabled = true;
    document.getElementById('progress-area').style.display = 'block';
    status.innerHTML = '';

    let successCount = 0;
    let errorCount = 0;

    for (let i = 0; i < files.length; i++) {
        const percent = Math.round((i / files.length) * 100);
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-text').textContent =
            `Photo ${i + 1} de ${files.length} en cours d'envoi...`;

        try {
            const compressed = await compressImage(files[i]);
            const formData = new FormData();
            formData.append('event', event);
            formData.append('files', compressed);

            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success && data.new_count > 0) {
                successCount++;
            } else {
                errorCount++;
                console.error('Erreur upload:', data.error || `new_count=${data.new_count}`);
            }
        } catch (e) {
            errorCount++;
            console.error('Erreur rÃ©seau:', e);
        }
    }

    // Done
    document.getElementById('progress-bar').style.width = '100%';
    document.getElementById('progress-text').textContent = 'TerminÃ© !';

    if (successCount > 0) {
        status.innerHTML = `<p class="success">âœ“ ${successCount} photo(s) ajoutÃ©e(s) avec succÃ¨s${errorCount > 0 ? ` (${errorCount} erreur(s))` : ''}</p>`;
        document.getElementById('links-card').style.display = 'block';
    } else {
        status.innerHTML = `<p class="error">Ã‰chec de l'envoi. VÃ©rifiez votre connexion et rÃ©essayez.</p>`;
    }

    fileInput.value = '';
    updateFileCount();
    document.getElementById('upload-btn').disabled = false;
}

// Branding
fetch('/api/branding').then(r => r.json()).then(b => {
    if (b.logo_url || b.salon_name) {
        if (b.logo_url) document.getElementById('salon-logo').src = b.logo_url;
        else document.getElementById('salon-logo').style.display = 'none';
        if (b.salon_name) document.getElementById('salon-name-text').textContent = b.salon_name;
        document.getElementById('salon-branding').style.display = 'block';
    }
}).catch(() => {});

// QR Code
function showQR() {
    const modal = document.getElementById('qr-modal');
    const canvas = document.getElementById('qr-canvas');
    canvas.innerHTML = '';
    document.getElementById('qr-label').textContent = `Lien d'envoi de photos â€” ${name}`;
    modal.style.display = 'flex';
    new QRCode(canvas, {
        text: window.location.href,
        width: 240,
        height: 240,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
    });
}

function closeQR() {
    document.getElementById('qr-modal').style.display = 'none';
}

function printQR() {
    const canvas = document.getElementById('qr-canvas');
    const img = canvas.querySelector('img') || canvas.querySelector('canvas');
    const src = img.tagName === 'CANVAS' ? img.toDataURL() : img.src;
    const win = window.open('', '_blank');
    win.document.write(`<!DOCTYPE html><html><head><title>QR Code â€” ${name}</title>
        <style>body{margin:0;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:Arial,sans-serif;}
        img{width:300px;height:300px;}p{margin-top:16px;font-size:14px;color:#333;text-align:center;}</style></head>
        <body><img src="${src}"><p>${name}<br><small>${window.location.href}</small></p></body></html>`);
    win.document.close();
    win.focus();
    win.print();
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</body>
</html>
