<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envoyer des photos</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div class="container">
    <div id="portrait-section" style="display:none">
        <div class="portrait-frame">
            <img id="portrait-img" src="" alt="">
        </div>
    </div>
    <h1 id="page-title">Hommage Fun√©raire</h1>
    <p class="subtitle" id="page-sub">Partagez vos photos en souvenir</p>

    <div class="card">
        <label class="file-drop" for="file-input">
            <span class="file-icon">üì∑</span>
            <span class="file-text">Cliquez ici pour choisir vos photos</span>
            <span class="file-hint">ou glissez-d√©posez les photos ici</span>
        </label>
        <input type="file" id="file-input" multiple accept="image/*" style="display:none">

        <p id="file-count" class="file-count-text">Aucune photo s√©lectionn√©e</p>

        <button id="upload-btn" onclick="startUpload()">Envoyer les photos</button>

        <div id="progress-area" style="display:none">
            <div class="progress-bar-wrap">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <p id="progress-text" class="progress-text">Pr√©paration...</p>
        </div>

        <div id="status"></div>
    </div>

    <div class="card" id="links-card" style="display:none">
        <a id="slideshow-link" class="btn-gold btn-block">‚ñ∂ Voir le Slideshow</a>
    </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const event = params.get('event') || 'default';
const name = params.get('name') || 'M√©morial';

document.getElementById('page-title').textContent = name;
document.getElementById('page-sub').textContent = `Partagez vos photos en souvenir de ${name}`;
document.title = `Envoyer des photos - ${name}`;

const portrait = params.get('portrait');
if (portrait) {
    document.getElementById('portrait-img').src = portrait;
    document.getElementById('portrait-img').alt = name;
    document.getElementById('portrait-section').style.display = 'block';
}

const slideshowUrl = `/slideshow.html?event=${encodeURIComponent(event)}&name=${encodeURIComponent(name)}`;
document.getElementById('slideshow-link').href = slideshowUrl;

// File input handling
const fileInput = document.getElementById('file-input');
const fileDrop = document.querySelector('.file-drop');

fileDrop.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', updateFileCount);

// Drag and drop
fileDrop.addEventListener('dragover', e => { e.preventDefault(); fileDrop.classList.add('drag-over'); });
fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('drag-over'));
fileDrop.addEventListener('drop', e => {
    e.preventDefault();
    fileDrop.classList.remove('drag-over');
    fileInput.files = e.dataTransfer.files;
    updateFileCount();
});

function updateFileCount() {
    const count = fileInput.files.length;
    document.getElementById('file-count').textContent =
        count === 0 ? 'Aucune photo s√©lectionn√©e' :
        count === 1 ? '1 photo s√©lectionn√©e' :
        `${count} photos s√©lectionn√©es`;
}

// Compress an image using Canvas (keeps images under ~600KB to respect Vercel's 4.5MB limit)
function compressImage(file) {
    return new Promise(resolve => {
        // Skip non-compressible types (HEIC, GIF, etc.)
        if (!['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) {
            resolve(file);
            return;
        }
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
            URL.revokeObjectURL(url);
            const MAX = 1920;
            let { width, height } = img;
            if (width > MAX || height > MAX) {
                if (width >= height) { height = Math.round(height * MAX / width); width = MAX; }
                else { width = Math.round(width * MAX / height); height = MAX; }
            }
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            canvas.toBlob(
                blob => resolve(new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' })),
                'image/jpeg', 0.85
            );
        };
        img.onerror = () => { URL.revokeObjectURL(url); resolve(file); };
        img.src = url;
    });
}

async function startUpload() {
    const files = Array.from(fileInput.files);
    const status = document.getElementById('status');

    if (files.length === 0) {
        status.innerHTML = '<p class="error">Veuillez choisir au moins une photo.</p>';
        return;
    }

    document.getElementById('upload-btn').disabled = true;
    document.getElementById('progress-area').style.display = 'block';
    status.innerHTML = '';

    let successCount = 0;
    let errorCount = 0;

    for (let i = 0; i < files.length; i++) {
        const percent = Math.round((i / files.length) * 100);
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-text').textContent =
            `Photo ${i + 1} de ${files.length} en cours d'envoi...`;

        try {
            const compressed = await compressImage(files[i]);
            const formData = new FormData();
            formData.append('event', event);
            formData.append('files', compressed);

            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success && data.new_count > 0) {
                successCount++;
            } else {
                errorCount++;
                console.error('Erreur upload:', data.error || `new_count=${data.new_count}`);
            }
        } catch (e) {
            errorCount++;
            console.error('Erreur r√©seau:', e);
        }
    }

    // Done
    document.getElementById('progress-bar').style.width = '100%';
    document.getElementById('progress-text').textContent = 'Termin√© !';

    if (successCount > 0) {
        status.innerHTML = `<p class="success">‚úì ${successCount} photo(s) ajout√©e(s) avec succ√®s${errorCount > 0 ? ` (${errorCount} erreur(s))` : ''}</p>`;
        document.getElementById('links-card').style.display = 'block';
    } else {
        status.innerHTML = `<p class="error">√âchec de l'envoi. V√©rifiez votre connexion et r√©essayez.</p>`;
    }

    fileInput.value = '';
    updateFileCount();
    document.getElementById('upload-btn').disabled = false;
}
</script>
</body>
</html>
